name: eslint (npx, discover files)

on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Debug repo (quick)
        run: |
          echo "Current dir: $(pwd)"
          echo "Git status:"
          git status --porcelain
          echo
          echo "Tracked files (top-level):"
          git ls-files | sed -n '1,200p'
          echo
          echo "Filesystem snapshot (top 200 lines):"
          ls -la | sed -n '1,200p'

      - name: Run ESLint on discovered JS files
        run: |
          set -euo pipefail
          mapfile -d '' files < <(find . -type f \( -iname '*.user.js' -o -iname '*.js' \) -not -path './node_modules/*' -print0)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No .user.js or .js files found in workspace â€” skipping ESLint."
            exit 0
          fi
          for f in "${files[@]}"; do printf " - %s\n" "$f"; done
          npx eslint "${files[@]}" --max-warnings=0 -f github
